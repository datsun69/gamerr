{% extends "base.html" %}

{% block title %}Search Results - Gamerr{% endblock %}

{% block content %}
    <h1 id="page-title">Searching...</h1>        
    <div id="results-container">
        <p>Please wait while we fetch results from IGDB.</p>
        <div class="spinner"></div> <!-- Assuming you have a .spinner class in your CSS -->
    </div>
{% endblock %}

{% block scripts %}
<script>
    const taskId = "{{ task_id }}";
    const profiles = {{ profiles | tojson }};
    const resultsContainer = document.getElementById('results-container');
    const pageTitle = document.getElementById('page-title');

    function timestampToDate(timestamp) {
        if (!timestamp) return 'N/A';
        return new Date(timestamp * 1000).toISOString().split('T')[0];
    }

    async function pollForResults() {
        try {
            const response = await fetch(`/add/results/data/${taskId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.status === 'COMPLETE') {
                clearInterval(pollingInterval);
                renderResults(data.results);
            } else if (data.status === 'FAILED' || data.status === 'NOT_FOUND') {
                clearInterval(pollingInterval);
                resultsContainer.innerHTML = '<div class="card"><p>Search failed or task was not found.</p></div>';
            }
        } catch (error) {
            console.error("Polling failed:", error);
            clearInterval(pollingInterval);
            resultsContainer.innerHTML = '<div class="card"><p>An error occurred.</p></div>';
        }
    }

    function renderResults(results) {
        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="card"><p>No games found for your search term.</p></div>';
            pageTitle.innerText = 'Search Results';
            return;
        }

        let html = '<ul class="game-list">'; // Use a different class to avoid conflicts with index.html
        results.forEach(game => {
            const releaseDate = timestampToDate(game.release_timestamp);
            const coverUrl = game.cover_url ? `https:${game.cover_url}` : `https://via.placeholder.com/150x200?text=No+Cover`;

            let profileOptionsHtml = '<select name="profile_id" class="profile-select">';
            if (profiles && profiles.length > 0) {
                profiles.forEach(profile => {
                    // The 'selected' attribute will pre-select the default profile
                    const isSelected = profile.is_default ? 'selected' : '';
                    profileOptionsHtml += `<option value="${profile.id}" ${isSelected}>${profile.name}</option>`;
                });
            } else {
                profileOptionsHtml += '<option value="">No Profiles Available</option>';
            }
            profileOptionsHtml += '</select>';            
            
            html += `
            <li class="game-card">
                <img src="${coverUrl}" class="game-cover" alt="Cover for ${game.name}">
                    <div class="game-details">
                        <h3>${game.name}</h3>
                        <p class="no-padding no-margin">${releaseDate}</p>
                    </div>
                    <form action="{{ url_for('main.add_game_confirm') }}" method="post" class="game-card-actions">
                        <input type="hidden" name="igdb_id" value="${game.id}">
                        
                        ${profileOptionsHtml} 
                        
                        <div class="button-group">
                            <button type="submit" class="btn btn-blue" title="Add Game"><span class="material-symbols-outlined">add</span></button>
                            <a href="https://www.igdb.com/games/${game.slug}" target="_blank" rel="noopener noreferrer" class="btn btn-lime" title="View on IGDB">
                                <span class="material-symbols-outlined">open_in_new</span>
                            </a>
                        </div>
                    </form>
                </li>`;
            });
        html += '</ul>';
        pageTitle.innerText = 'Search Results';
        resultsContainer.innerHTML = html;
    }

    const pollingInterval = setInterval(pollForResults, 2000);
    pollForResults();
</script>
{% endblock %}