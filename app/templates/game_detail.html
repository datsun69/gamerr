{% extends "base.html" %}

{% block title %}{{ game.official_title }} - Gamerr{% endblock %}

{% block content %}
<div class="game-detail-container">
    <!-- Header Section for rich metadata -->
    <div class="game-detail-header card">
        <img src="https:{{ game.cover_url }}" alt="Cover for {{ game.official_title }}" class="game-detail-cover">

        <div class="status-badge-container">
            <span class="status-badge
                {% if 'definitely cracked' in game.status.lower() %}status-cracked
                {% elif 'probably cracked' in game.status.lower() %}status-p2p
                {% else %}status-{{ game.status.lower().replace('%', '') }}
                {% endif %}" id="game-status">
                {{ game.status|replace("Definitely Cracked", "Cracked (scene)")|replace("Probably Cracked (P2P)", "Cracked (P2P)") }}
            </span>  
        </div>

        <div class="game-detail-info">
            <h1>{{ game.official_title }}</h1>
            <p>{{ game.release_date or 'N/A' }}</p>
            <div class="metadata-pills">
                {% if game.critic_score is not none and game.critic_score > 0 %}<span class="pill"><span class="material-symbols-outlined">star</span>Critic Score: {{ game.critic_score }}</span>{% endif %}
                {% if game.user_score is not none and game.user_score > 0 %}<span class="pill"><span class="material-symbols-outlined">person</span>User Score: {{ game.user_score }}</span>{% endif %}
            </div>
            <p class="game-summary nomobile">{{ game.summary }}</p>
            <div class="metadata-pills">
                {% for genre in game.genres.split(',') %}<span class="pill pill-genre">{{ genre.strip() }}</span>{% endfor %}
            </div>
            <div class="game-details-action-buttons" style="margin-bottom: 1rem;">

                {% if game.videos_urls %}
                    <a href="{{ game.videos_urls.split(',')[0] }}" target="_blank" rel="noopener noreferrer" class="btn btn-lime">
                        <span class="material-symbols-outlined">play_circle</span> Watch Trailer
                    </a>
                {% endif %}
                {% if game.slug %}
                <a href="https://www.igdb.com/games/{{ game.slug }}" target="_blank" rel="noopener noreferrer" class="btn btn-lime">
                    <span class="material-symbols-outlined">open_in_new</span>
                </a>
                {% endif %}      

            </div>
            <div class="game-details-action-buttons">

                <form id="profile-update-form" action="{{ url_for('main.update_game_settings', game_id=game.id) }}" method="POST">
                    <div class="form-group">
                        <select name="profile_id" id="profile_id" class="profile-select">
                            <option value="0">-- Select Profile --</option>
                            {% for profile in profiles %}
                                <option value="{{ profile.id }}" {% if game.profile_id == profile.id %}selected{% endif %}>
                                    {{ profile.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>   

                <button id="manual-scan-btn" class="btn btn-blue" data-game-id="{{ game.id }}">
                    <span class="material-symbols-outlined">search</span>
                    Scan for Releases
                </button>

                <form action="{{ url_for('main.delete_game', game_id=game.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this game from the database?');">
                    <button type="submit" class="btn btn-red">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </form>      
            </div>      
        </div>
    </div>

    <!-- Main Release Card -->
    
    <details class="content-card" style="margin:0" open>
        <summary class="collapsible-header">
            <div>
            <h2>Main Release</h2>
            </div>
            <span class="material-symbols-outlined collapsible-icon">keyboard_arrow_down</span>
        </summary>
        <div class="details-content main-release-info" style="border: none;">
            <div class="release-details">
                <p>{{ game.release_name or 'N/A' }}</p>
                <p><strong>Release Group:</strong> {{ game.release_group or 'N/A' }}</p>
            </div>
            <div class="release-actions">
                {# --- FIX: Accessing object attribute with a dot --- #}
                {% if game.nfo_img_path %}
                <a href="{{ url_for('main.serve_nfo_file', filename=game.nfo_img_path) }}" class="btn btn-pink" target="_blank">
                    <span class="material-symbols-outlined">description</span> View NFO
                </a>
                {% endif %}
    
                <a href="{{ url_for('main.interactive_search', game_id=game.id) }}" class="btn btn-blue">
                    <span class="material-symbols-outlined">search</span> Search
                </a>
            </div>
        </div>
    </details>


    {% if game.alternative_releases %}
    <details class="content-card" style="margin:0">
        <summary class="collapsible-header">
            <div>
            <h2>{% if game.release_name %}Alternative Releases{% else %}Releases{% endif %}</h2>
            </div>
            <span class="material-symbols-outlined collapsible-icon">keyboard_arrow_down</span>
        </summary>
        <div class="details-content">
            {% for alt in game.alternative_releases %}
                <div class="main-release-info">            
                    <div class="release-details">
                        <p>{{ alt.release_name }}</p>
                        <p><strong>Source:</strong> {{ alt.source }}</p>
                    </div>
                    <div class="release-actions">
                        {# --- NEW: NFO button for alternative releases --- #}
                        {% if alt.nfo_img_path %}
                        <a href="{{ url_for('main.serve_nfo_file', filename=alt.nfo_img_path) }}" class="btn btn-sm btn-pink" target="_blank">
                            <span class="material-symbols-outlined">description</span> View NFO
                        </a>
                        {% endif %}
                        
                        <a href="{{ url_for('main.interactive_search', game_id=game.id, q=alt.release_name) }}" class="btn btn-sm btn-primary">
                            <span class="material-symbols-outlined">search</span> Search
                        </a>
                    </div>
                </div>
            {% endfor %}                    
        </div>
    </details>
    {% endif %}



    <details class="content-card" style="margin:0">
        <summary class="collapsible-header">
            <div>
            <h2>Additional Content</h2>
            </div>
            <span class="material-symbols-outlined collapsible-icon">keyboard_arrow_down</span>
        </summary>
        <div class="details-content">
            {% for release in game.additional_releases %}
                <div class="main-release-info">            
                    <div class="release-details">
                        <p>{{ release.release_name }}</p>
                        <span class="pill pill-type-{{ release.release_type.lower() }}">{{ release.release_type }}</span> {{ release.status }}
                    </div>
        
        
                    <div class="release-actions">
                        <a href="{{ url_for('main.interactive_search', game_id=game.id, q=release.release_name, additional_release_id=release.id) }}" class="btn btn-primary btn-sm" title="Search for this release">
                            <span class="material-symbols-outlined">search</span> Search
                        </a>
                    </div>
                </div>
                {% else %}
                No additional content has been found for this game yet.
                {% endfor %}                  
        </div>
    </details>  


</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scanButton = document.getElementById('manual-scan-btn');
        const gameStatusSpan = document.getElementById('game-status');
        const profileSelect = document.getElementById('profile_id');
        const profileForm = document.getElementById('profile-update-form');
    
        // --- The Polling Function ---
        const pollGameStatus = (gameId) => {
            let pollCount = 0;
            const maxPolls = 60; // Poll for a maximum of 3 minutes (60 * 3s)
    
            const intervalId = setInterval(async () => {
                if (pollCount >= maxPolls) {
                    clearInterval(intervalId);
                    console.error("Polling timed out.");
                    // Reset the button if polling fails
                    scanButton.disabled = false;
                    scanButton.innerHTML = '<span class="material-symbols-outlined">search</span> Scan for Releases';
                    scanButton.classList.remove('btn-green'); // Ensure it's not stuck green
                    return;
                }
    
                try {
                    const response = await fetch(`/game/status/${gameId}`);
                    const data = await response.json();
                    
                    // Update the main status text in real-time
                    gameStatusSpan.textContent = data.status;
    
                    // Check if the scan is complete
                    if (data.status !== 'Processing') {
                        clearInterval(intervalId); // Stop polling
                        
                        // Final success UI update
                        scanButton.disabled = false; // Re-enable the button
                        scanButton.innerHTML = '<span class="material-symbols-outlined">task_alt</span> Scan Complete';
                        scanButton.classList.add('btn-green'); // Add a success color
    
                        // Optional: Reset the button back to normal after a few seconds
                        setTimeout(() => {
                            scanButton.innerHTML = '<span class="material-symbols-outlined">search</span> Scan for Releases';
                            scanButton.classList.remove('btn-green');
                        }, 20000);
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                    clearInterval(intervalId);
                }
                
                pollCount++;
            }, 3000); // Poll every 3 seconds
        };
    
        // --- The Initial Click Handler ---
        scanButton.addEventListener('click', async () => {
            const gameId = scanButton.dataset.gameId;
            
            scanButton.disabled = true;
            scanButton.innerHTML = '<span class="material-symbols-outlined spinner2">progress_activity</span> Scanning...';
            if (gameStatusSpan) {
                gameStatusSpan.textContent = 'Processing';
            }
    
            try {
                const response = await fetch(`/game/scan/${gameId}`, {
                    method: 'POST',
                });
                
                if (response.ok) {
                    // If the initial request was successful, start polling for completion.
                    pollGameStatus(gameId);
                } else {
                    console.error("Initial scan request failed");
                    scanButton.disabled = false;
                    scanButton.innerHTML = '<span class="material-symbols-outlined">search</span> Scan for Releases';
                }
            } catch (error) {
                console.error('An error occurred:', error);
                scanButton.disabled = false;
                scanButton.innerHTML = '<span class="material-symbols-outlined">search</span> Scan for Releases';
            }
        });
        profileSelect.addEventListener('change', function() {
        // When the selection changes, submit the form
        profileForm.submit();
    });        
    });
    </script>
{% endblock %}