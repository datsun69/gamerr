{% extends "base.html" %}

{% block title %}Library - Gamerr{% endblock %}

{% block content %}

<div class="row mb-3">
      <form method="GET" action="{{ url_for('main.index') }}" class="form-inline">
        <div class="form-group">
          <label for="filter_status">Status:</label>
          <select name="filter_status" id="filter_status" class="form-control" onchange="this.form.submit()">
            <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Statuses</option>
            {% for status in all_statuses %}
              <option value="{{ status }}" {% if status == current_filter %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="sort_by">Sort By:</label>
          <select name="sort_by" id="sort_by" class="form-control" onchange="this.form.submit()">
            <option value="id_desc" {% if current_sort == 'id_desc' %}selected{% endif %}>Recently Added</option>
            <option value="title_asc" {% if current_sort == 'title_asc' %}selected{% endif %}>Title (A-Z)</option>
            <option value="release_date_desc" {% if current_sort == 'release_date_desc' %}selected{% endif %}>Release Date (Newest)</option>
          </select>
        </div>
      </form>
  </div>

<ul class="game-list">
    {% for game in games %}
        <!-- The LI is the main container with all data attributes -->
        <li class="game-card" data-id="{{ game.id }}" data-status="{{ game.status }}">
            
            <!-- The link wraps the visual elements -->
            <a href="{{ url_for('main.game_detail', game_id=game.id) }}" class="game-card-link">
                {% if game.cover_url %}
                    <img src="https:{{ game.cover_url }}" alt="{{ game.official_title }} Cover" class="game-cover">
                {% endif %}
                <div class="game-details">
                    <h3>{{ game.official_title }}</h3>
                    <p>{{ game.release_date or 'N/A' }}</p>
                </div>
            </a>

            <!-- The status badge is separate from the link, for easier updates -->
            <div class="status-badge-container">
                <span class="status-badge game-status
                    {% if 'definitely cracked' in game.status.lower() %}status-cracked
                    {% elif 'probably cracked' in game.status.lower() %}status-p2p
                    {% elif 'processing' in game.status.lower() %}status-processing
                    {% else %}status-{{ game.status.lower().replace('%', '') }}
                    {% endif %}">
                    {% if game.status == 'Processing' %}
                        <div class="spinner-inline"></div> Processing...
                    {% else %}
                        {{ game.status|replace("Definitely Cracked", "Cracked")|replace("Probably Cracked (P2P)", "Cracked") }}
                    {% endif %}
                </span>
            </div>
        </li>
    {% else %}
        <li class="game-card-placeholder">
            <p>No games in your library yet.</p>
            <a href="{{ url_for('main.add_game_search') }}" class="btn btn-primary">Add Your First Game</a>
        </li>
    {% endfor %}
</ul>

{% if pagination %}
<nav aria-label="Game navigation">
  <ul class="pagination justify-content-center">

    <!-- "Previous" Link -->
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('main.index', page=pagination.prev_num) }}">Previous</a>
    </li>

    <!-- Page Number Links -->
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if pagination.page == page_num %}
          <li class="page-item active"><a class="page-link" href="{{ url_for('main.index', page=page_num) }}">{{ page_num }}</a></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=page_num) }}">{{ page_num }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}

    <!-- "Next" Link -->
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('main.index', page=pagination.next_num) }}">Next</a>
    </li>

  </ul>
</nav>
{% endif %}

{% endblock %}





{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all cards that need polling
        const gamesToPoll = document.querySelectorAll('.game-card[data-status="Processing"], .game-card[data-status*="Downloading"], .game-card[data-status="Snatched"], .game-card[data-status="Monitoring"]');

        const statusClassMap = {
            'definitely cracked': 'status-cracked',
            'probably cracked (p2p)': 'status-p2p',
            'processing': 'status-processing',
            'monitoring': 'status-monitoring',
            'downloading': 'status-downloading',
            'downloaded': 'status-downloaded',
            'snatched': 'status-snatched',
            'imported': 'status-imported'
        };

        if (gamesToPoll.length > 0) {
            const checkStatuses = () => {
                gamesToPoll.forEach(card => {
                    const gameId = card.dataset.id;
                    // Only poll if the card is still in a transitional state
                    if (!['Imported', 'Definitely Cracked', 'Probably Cracked (P2P)'].includes(card.dataset.status)) {
                        fetch(`/game/status/${gameId}`)
                            .then(response => response.json())
                            .then(data => {
                                // Only update if the status has actually changed
                                if (card.dataset.status !== data.status) {
                                    card.dataset.status = data.status; // Update the data attribute immediately

                                    const statusElement = card.querySelector('.game-status');
                                    if (statusElement) {
                                        let displayStatus = data.status
                                            .replace("Definitely Cracked", "Cracked")
                                            .replace("Probably Cracked (P2P)", "Cracked");
                                        
                                        // Update status text/spinner
                                        if (data.status === 'Processing') {
                                            statusElement.innerHTML = '<div class="spinner-inline"></div> Processing...';
                                        } else {
                                            statusElement.innerHTML = displayStatus;
                                        }

                                        // Update the status class for the correct color
                                        Object.values(statusClassMap).forEach(cls => statusElement.classList.remove(cls));
                                        let statusKey = data.status.toLowerCase();
                                        if (statusKey.startsWith('downloading')) {
                                            statusKey = 'downloading'; // Group all "Downloading X%" under one class
                                        }
                                        const newStatusClass = statusClassMap[statusKey];
                                        if (newStatusClass) {
                                            statusElement.classList.add(newStatusClass);
                                        }
                                    }
                                }
                            });
                    }
                });
            };
            setInterval(checkStatuses, 5000);
        }
    });
</script>
{% endblock %}