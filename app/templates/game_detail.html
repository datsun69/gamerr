{% extends "base.html" %}

{% block title %}{{ game.official_title }} - Gamerr{% endblock %}

{% block content %}
<div class="game-detail-container">
    <!-- Header Section for rich metadata -->
    <div class="game-detail-header card">
        <img src="https:{{ game.cover_url }}" alt="Cover for {{ game.official_title }}" class="game-detail-cover">



        <div class="status-badge-container">
            <span class="status-badge
                {% if 'definitely cracked' in game.status.lower() %}status-cracked
                {% elif 'probably cracked' in game.status.lower() %}status-p2p
                {% else %}status-{{ game.status.lower().replace('%', '') }}
                {% endif %}">
                {{ game.status|replace("Definitely Cracked", "Cracked (scene)")|replace("Probably Cracked (P2P)", "Cracked (P2P)") }}
            </span>  
        </div>

        <div class="game-detail-info">
            <h1>{{ game.official_title }}</h1>
            <p>{{ game.release_date or 'N/A' }}</p>
            <div class="metadata-pills">
                {% if game.critic_score > 0 %}<span class="pill"><span class="material-symbols-outlined">star</span>Critic Score: {{ game.critic_score }}</span>{% endif %}
                {% if game.user_score > 0 %}<span class="pill"><span class="material-symbols-outlined">person</span>User Score: {{ game.user_score }}</span>{% endif %}
            </div>
            <p class="game-summary">{{ game.summary }}</p>
            <div class="metadata-pills">
                {% for genre in game.genres.split(',') %}<span class="pill pill-genre">{{ genre.strip() }}</span>{% endfor %}
            </div>
            <div class="game-details-action-buttons">
                {% if game.videos_urls %}
                    <a href="{{ game.videos_urls.split(',')[0] }}" target="_blank" rel="noopener noreferrer" class="btn btn-blue">
                        <span class="material-symbols-outlined">play_circle</span> Watch Trailer
                    </a>
                {% endif %}
                {% if game.slug %}
                <a href="https://www.igdb.com/games/{{ game.slug }}" target="_blank" rel="noopener noreferrer" class="btn btn-lime">
                    <span class="material-symbols-outlined">open_in_new</span>
                </a>
                {% endif %}                
                <form action="{{ url_for('main.delete_game', game_id=game.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this game from the database?');">
                    <button type="submit" class="btn btn-red">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </form>      
            </div>      
        </div>
    </div>

    <!-- Main Release Card -->
    <div class="card">
        <h2>Main Release</h2>
        <div class="main-release-info">
            <div class="release-details">

                <p>{{ game.release_name or 'N/A' }}</p>
                <p><strong>Release Group:</strong> {{ game.release_group or 'N/A' }}</p>
            </div>
            <div class="release-actions">
                
                {% if game['nfo_img_path'] %}
                <a href="{{ url_for('main.serve_nfo_file', filename=game['nfo_img_path']) }}" class="btn btn-pink" target="_blank"><span class="material-symbols-outlined">description</span>View NFO</a>
                {% else %}{% endif %}                

                <a href="{{ url_for('main.interactive_search', game_id=game.id) }}" class="btn btn-blue">
                    <span class="material-symbols-outlined">search</span> Search
                </a>

            </div>
        </div>
    </div>

    <!-- Content Management Section -->
    <div class="card">
        <h2>Additional Content</h2>
        <table class="activity-table">
            <thead>
                <tr>
                    <th>Release Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th style="text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for release in game.additional_releases %}
                <tr>
                    <td>{{ release.release_name }}</td>
                    <td><span class="pill pill-type-{{ release.release_type.lower() }}">{{ release.release_type }}</span></td>
                    <td>{{ release.status }}</td>
                    <td style="text-align: right;">
                        <!-- This link is the key to making the search button work -->
                        <a href="{{ url_for('main.interactive_search', game_id=game.id, q=release.release_name) }}" class="btn btn-primary btn-sm" title="Search for this release">
                            <span class="material-symbols-outlined">search</span>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No additional content has been found for this game yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}